/*!
 * chartjs-plugin-piechart-outlabels
 * http://chartjs.org/
 * Version: 0.1.3
 *
 * Copyright 2020 Neckster
 * Released under the MIT license
 * https://github.com/Neckster/chartjs-plugin-piechart-outlabels/blob/master/LICENSE
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Chart)}(this,(function(t){"use strict";var e=(t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t).helpers,i=e.merge(e,{toFontString:function(t){return!t||e.isNullOrUndef(t.size)||e.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family},textSize:function(t,e,i){var s,l=[].concat(e),n=l.length,h=t.font,o=0;for(t.font=i.string,s=0;s<n;++s)o=Math.max(t.measureText(l[s]).width,o);return t.font=h,{height:n*i.lineHeight,width:o}},parseFont:function(i,s){var l=t.defaults.global,n=e.valueOrDefault(i.size,l.defaultFontSize),h=e.valueOrDefault(i.titleSize,l.defaultFontSize);i.resizable&&(n=this.adaptTextSizeToHeight(s,i.minSize,i.maxSize),h=this.adaptTextSizeToHeight(s,i.minSize,i.maxSize));var o={family:e.valueOrDefault(i.family,l.defaultFontFamily),lineHeight:e.options.toLineHeight(i.lineHeight,n),size:n,style:e.valueOrDefault(i.style,l.defaultFontStyle),weight:e.valueOrDefault(i.weight,null),string:""},r={family:e.valueOrDefault(i.titleFamily,l.defaultFontFamily),lineHeight:e.options.toLineHeight(i.lineHeight,n),size:h,style:e.valueOrDefault(i.titleStyle,l.defaultFontStyle),weight:e.valueOrDefault(i.titleWeight,null),string:""};return o.string=e.toFontString(o),o.titleString=e.toFontString(r),o},adaptTextSizeToHeight:function(t,e,i){var s=t/100*2.5;return e&&s<e?e:i&&s>i?i:s}}),s={LABEL_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:4,right:4,bottom:4,left:4},textAlign:"center",stretch:40,text:"%l %p",zoomOutPercentage:50,percentPrecision:1,valuePrecision:3},l=function(){Math.trunc||(Math.trunc=function(t){return(t=+t)-t%1||(isFinite(t)&&0!==t?t<0?-0:0:t)}),t.defaults.outlabeledDoughnut=t.defaults.doughnut,t.defaults.outlabeledPie=t.defaults.pie;var e=function(e){t.controllers.doughnut.prototype.update.call(this);var i=this,l=i.getMeta(),n=i.chart.options.zoomOutPercentage||s.zoomOutPercentage;i.outerRadius*=1-n/100,i.innerRadius*=1-n/100,t.helpers.each(l.data,(function(t,s){i.updateElement(t,s,e)}))},i=t.controllers.doughnut.extend({update:e}),l=t.controllers.pie.extend({update:e});t.controllers.outlabeledPie=l,t.controllers.outlabeledDoughnut=i},n=function(t,e,i=0){var s=(t.startAngle+t.endAngle)/2,l=Math.cos(s),n=Math.sin(s),h=t.outerRadius,o=h+e;return{x:t.x+l*o,y:t.y+n*o,d:o,arc:t,anchor:{x:t.x+l*(h+i),y:t.y+n*(h+i)},copy:{x:t.x+l*o,y:t.y+n*o}}},h=function(t,e){var i=t.arc,s=t.d,l=(i.startAngle+i.endAngle)/2,n=Math.cos(l),h=Math.sin(l);return s+=e,{x:i.x+n*s,y:i.y+h*s,d:s,arc:i,anchor:t.anchor,copy:{x:i.x+n*s,y:i.y+h*s}}},o=t.helpers,r=s.LABEL_KEY,a=function(e,i,l,a,d){var c=t.helpers.options.resolve;if(!c([a.display,!0],d,i))throw new Error("Label display property is set to false.");var f=d.dataset.data[i],u=d.labels[i],x=c([a.text,s.text],d,i);((x=x.replace(/%l/gi,u)).match(/%v\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%v\./gi,"");return e.length?+e:a.valuePrecision||s.valuePrecision})).forEach((function(t){x=x.replace(/%v\.?(\d*)/i,f.toFixed(t))})),(x.match(/%p\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%p\./gi,"");return e.length?+e:a.percentPrecision||s.percentPrecision})).forEach((function(t){x=x.replace(/%p\.?(\d*)/i,(100*d.percent).toFixed(t)+"%")}));var g=x.match(/[^\r\n]+/g);if(!g||!g.length)throw new Error("No text to show.");for(var y=0;y<g.length;++y)g[y]=g[y].trim();this.init=function(t,n){this.encodedText=a.text,this.text=t,this.lines=n,this.label=u,this.value=f,this.ctx=l,this.style={backgroundColor:c([a.backgroundColor,s.backgroundColor,"black"],d,i),borderColor:c([a.borderColor,s.borderColor,"black"],d,i),borderRadius:c([a.borderRadius,0],d,i),borderWidth:c([a.borderWidth,0],d,i),lineWidth:c([a.lineWidth,2],d,i),lineColor:c([a.lineColor,s.lineColor,"black"],d,i),color:c([a.color,"white"],d,i),font:o.parseFont(c([a.font,{resizable:!0}]),l.canvas.style.height.slice(0,-2)),padding:o.options.toPadding(c([a.padding,0],d,i)),textAlign:c([a.textAlign,"left"],d,i)},this.stretch=c([a.stretch,40],d,i),this.offsetLine=c([a.offsetLine,0],d,i),this.size=o.textSize(l,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0},this.predictedOffset=this.offset;var h=-(e._model.startAngle+e._model.endAngle)/2/Math.PI,r=Math.abs(h-Math.trunc(h));r>.45&&r<.55?this.predictedOffset.x=0:h<=.45&&h>=-.45?this.predictedOffset.x=this.size.width/2:h>=-1.45&&h<=-.55&&(this.predictedOffset.x=-this.size.width/2)},this.init(x,g),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth,e=this.textRect.height+2*this.style.borderWidth;return{x:this.textRect.x-this.style.padding.left-this.style.borderWidth,y:this.textRect.y-this.style.padding.top-this.style.borderWidth,width:t+=this.style.padding.width,height:e+=this.style.padding.height}},this.computeTextRect=function(){return{x:this.center.x-this.size.width/2,y:this.center.y-this.size.height/2,width:this.size.width,height:this.size.height}},this.getPoints=function(){return[{x:this.labelRect.x,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y},{x:this.labelRect.x+this.labelRect.width,y:this.labelRect.y+this.labelRect.height},{x:this.labelRect.x,y:this.labelRect.y+this.labelRect.height}]},this.containsPoint=function(t,e){return e||(e=5),this.labelRect.x-e<=t.x&&t.x<=this.labelRect.x+this.labelRect.width+e&&this.labelRect.y-e<=t.y&&t.y<=this.labelRect.y+this.labelRect.height+e},this.drawText=function(){var t,e,i,s=this.style.textAlign,l=this.style.font.lineHeight,n=this.style.color,h=this.lines.length;if(h&&n)for(t=this.textRect.x,e=this.textRect.y+l/2,"center"===s?t+=this.textRect.width/2:"end"!==s&&"right"!==s||(t+=this.textRect.width),this.ctx.fillStyle=n,this.ctx.textAlign=s,this.ctx.textBaseline="middle",i=0;i<h;++i)this.lines.length>1&&0===i?this.ctx.font=this.style.font.titleString:this.ctx.font=this.style.font.string,this.ctx.fillText(this.lines[i],Math.round(t),Math.round(e),Math.round(this.textRect.width)),e+=l},this.drawLabel=function(){l.beginPath(),o.canvas.roundedRect(this.ctx,Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius),this.ctx.closePath(),this.style.backgroundColor&&(this.ctx.fillStyle=this.style.backgroundColor||"black",this.ctx.fill()),this.style.borderColor&&this.style.borderWidth&&(this.ctx.strokeStyle=this.style.borderColor,this.ctx.lineWidth=this.style.borderWidth,this.ctx.lineJoin="miter",this.ctx.stroke())},this.drawLine=function(){this.ctx.save(),this.ctx.strokeStyle=this.style.lineColor,this.ctx.lineWidth=this.style.lineWidth,this.ctx.lineJoin="miter",this.ctx.beginPath(),this.ctx.moveTo(this.center.anchor.x,this.center.anchor.y),this.ctx.lineTo(this.center.copy.x,this.center.copy.y),this.ctx.stroke(),this.ctx.restore()},this.draw=function(){this.drawLabel(),this.drawText()},this.update=function(t,e,i){this.center=n(t,this.stretch,this.offsetLine),this.moveLabelToOffset(),this.center.x+=this.offset.x,this.center.y+=this.offset.y;for(var s=!1;!s;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();var l=this.getPoints();s=!0;for(var o=0;o<i;++o){var a=e[o][r];if(a)for(var d=a.getPoints(),c=0;c<l.length;++c){if(a.containsPoint(l[c])){s=!1;break}if(this.containsPoint(d[c])){s=!1;break}}}s||(this.center=h(this.center,1),this.center.x+=this.offset.x,this.center.y+=this.offset.y)}},this.moveLabelToOffset=function(){this.predictedOffset.x<=0&&this.offset.x>this.predictedOffset.x?(this.offset.x-=this.offsetStep,this.offset.x<=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x)):this.predictedOffset.x>=0&&this.offset.x<this.predictedOffset.x&&(this.offset.x+=this.offsetStep,this.offset.x>=this.predictedOffset.x&&(this.offset.x=this.predictedOffset.x))}};l(),t.defaults.global.plugins.outlabels=s;var d=s.LABEL_KEY;t.plugins.register({id:"outlabels",resize:function(t,e,i){t.sizeChanged=!0},afterDatasetUpdate:function(t,e,s){var l,n,h,o,r,c,f=t.config.data.labels,u=t.data.datasets[e.index],x=function(t,e){var s=t.outlabels;return!1===s?null:(!0===s&&(s={}),i.merge({},[e,s]))}(u,s),g=x&&x.display,y=e.meta.data||[],b=t.ctx;for(b.save(),c=0;c<y.length;++c){if(n=(l=y[c])[d],h=u.data[c]/e.meta.total,o=null,g&&l&&!l.hidden)try{r={chart:t,dataIndex:c,dataset:u,labels:f,datasetIndex:e.index,percent:h},o=new a(l,c,b,x,r)}catch(t){o=null}n&&o&&!t.sizeChanged&&n.label===o.label&&n.encodedText===o.encodedText&&(o.offset=n.offset),l[d]=o}b.restore(),t.sizeChanged=!1},afterDatasetDraw:function(t,e){for(var i,s,l=e.meta.data||[],n=t.ctx,h=0;h<2*l.length;++h)(s=(i=l[h<l.length?h:h-l.length])[d])&&(h<l.length?(s.update(i._view,l,h),s.drawLine(n)):s.draw(n))}})}));
